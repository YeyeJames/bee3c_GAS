<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æ‹¼å­—å­¸å ‚">
    <meta name="mobile-web-app-capable" content="yes">

    <title>é€²éšæ‹¼å­—å­¸å ‚ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #ff758c; 
            --bg-color: #f3f6f9;
            --text-color: #2d3748;
            --card-bg: #ffffff;
            --font-main: 'Nunito', 'PingFang TC', 'Microsoft JhengHei', 'Segoe UI', sans-serif;
        }

        body.theme-forest { --primary-color: #43e97b; --secondary-color: #38f9d7; --bg-color: #e0f7fa; --text-color: #1a535c; }
        body.theme-candy { --primary-color: #ff9a9e; --secondary-color: #fecfef; --bg-color: #fff0f5; --text-color: #553c4d; }
        body.theme-dark { --primary-color: #4a5568; --secondary-color: #2d3748; --bg-color: #1a202c; --text-color: #e2e8f0; --card-bg: #2d3748; }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--bg-color) 0%, #e2e8f0 100%);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.5s ease;
            font-size: 18px;
            letter-spacing: 0.5px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            color: white;
            border-radius: 0 0 20px 20px;
            flex-shrink: 0;
            z-index: 100;
        }

        .user-info { display: flex; align-items: center; gap: 12px; cursor: pointer; transition: opacity 0.2s; }
        .user-info:active { opacity: 0.7; }
        
        .avatar {
            width: 48px; height: 48px;
            border-radius: 50%;
            background-color: white;
            border: 3px solid rgba(255,255,255,0.6);
            font-size: 28px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        #userTitle { font-weight: 800; font-size: 1.2em; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .stats-bar {
            display: flex; gap: 15px; font-weight: bold;
            background: rgba(255,255,255,0.25);
            padding: 6px 15px; border-radius: 20px; font-size: 1em;
            backdrop-filter: blur(5px);
        }

        .currency { color: #ffd700; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }

        .btn-store {
            background: var(--accent-color);
            border: none; padding: 8px 16px; border-radius: 20px;
            color: white; font-weight: bold; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(255, 117, 140, 0.4);
            font-size: 0.95em;
        }
        .btn-store:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(255, 117, 140, 0.4); }

        main {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            padding: 15px; width: 100%; max-width: 900px; margin: 0 auto;
            overflow: hidden; box-sizing: border-box;
        }

        .game-card {
            background: var(--card-bg); width: 100%; height: 100%;
            border-radius: 25px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            text-align: center; position: relative;
            display: flex; flex-direction: column;
            overflow-y: auto; box-sizing: border-box;
        }

        #setupScreen { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        #setupScreen h2 { font-size: 1.8em; margin-bottom: 1.5rem; color: var(--primary-color); }

        .category-select {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 15px; margin-bottom: 25px; flex: 1;
            max-height: 60vh; overflow-y: auto;
        }
        
        .cat-btn {
            padding: 20px; border: 2px solid rgba(102, 126, 234, 0.3);
            background: #fff; border-radius: 18px; cursor: pointer;
            font-size: 1.3em; font-weight: bold; color: var(--text-color);
            transition: all 0.3s; display: flex; flex-direction: column;
            align-items: center; justify-content: center; min-height: 100px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .cat-btn span { font-size: 0.7em; font-weight: normal; margin-top: 8px; opacity: 0.7; color: #718096; }
        .cat-btn:hover, .cat-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: transparent; color: white; transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
        }
        .cat-btn:hover span, .cat-btn.active span { color: rgba(255,255,255,0.9); }

        .game-area { display: none; height: 100%; flex-direction: column; }
        .game-area.active { display: flex; }

        .btn-back {
            position: absolute; top: 15px; left: 15px;
            background: rgba(255,255,255,0.9); border: 1px solid #e2e8f0;
            color: #718096; font-size: 0.95em; cursor: pointer; font-weight: bold;
            z-index: 10; transition: all 0.2s; display: flex; align-items: center;
            gap: 5px; padding: 8px 12px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-back:hover { color: var(--primary-color); border-color: var(--primary-color); transform: translateX(-2px); }

        .progress-hud {
            display: flex; justify-content: space-between; margin-top: 40px;
            margin-bottom: 10px; font-size: 1em; color: #718096;
            flex-shrink: 0; font-weight: 600;
        }

        .timer { 
            font-size: 1.5em; font-weight: 800; color: var(--primary-color); 
            margin: 5px 0; flex-shrink: 0; font-feature-settings: "tnum"; letter-spacing: 1px;
        }

        .word-info-card {
            background: #f8fafc; border-radius: 20px; padding: 15px 20px;
            margin-top: auto; text-align: left;
            border-top: 4px solid var(--primary-color);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.03); flex-shrink: 1;
            overflow-y: auto; max-height: 35vh; font-size: 1em; line-height: 1.6;
        }
        .word-pos { color: #a0aec0; font-style: italic; font-size: 0.9em; margin-bottom: 4px; font-weight: 600; }
        .word-meaning { font-size: 1.4em; font-weight: bold; color: var(--text-color); margin-bottom: 8px; letter-spacing: 0.5px; }
        .word-definition { font-size: 1em; color: #4a5568; margin-bottom: 10px; line-height: 1.5; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;}
        .word-sentence { 
            background: #fff; padding: 12px; border-radius: 12px; 
            font-size: 1.05em; color: #2d3748; border: 1px solid #e2e8f0; line-height: 1.6;
        }
        .word-sentence em {
            color: var(--primary-color); font-style: normal; font-weight: 800;
            background: rgba(102, 126, 234, 0.1); padding: 0 4px; border-radius: 4px; text-decoration: none;
        }

        .audio-controls {
            display: flex; justify-content: center; gap: 15px; margin: 10px 0;
            flex-wrap: wrap; flex-shrink: 0;
        }

        .btn-audio {
            width: 60px; height: 60px; border-radius: 20px; border: none;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; font-size: 26px; cursor: pointer;
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-audio:active { transform: scale(0.92); box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3); }
        .btn-audio.secondary { 
            background: #e2e8f0; color: #4a5568; width: 45px; height: 45px; 
            font-size: 20px; box-shadow: none; border-radius: 15px;
        }
        .btn-audio.secondary:hover { background: #cbd5e0; }
        .btn-audio.text-btn { 
            width: auto; height: 40px; padding: 0 16px; border-radius: 20px; 
            font-size: 15px; background: white; color: var(--primary-color);
            border: 2px solid var(--primary-color); box-shadow: none; font-weight: bold;
        }
        .btn-audio.text-btn:hover { background: var(--primary-color); color: white; }
        
        .recording-container {
            background: #edf2f7; border-radius: 50px; padding: 6px 20px;
            display: inline-flex; align-items: center; gap: 15px;
            margin: 5px 0 15px 0; border: 1px solid #e2e8f0;
            flex-shrink: 0; align-self: center;
        }
        .rec-status {
            font-size: 0.95em; color: #718096; min-width: 70px;
            text-align: left; font-weight: bold;
        }
        .rec-controls { display: flex; gap: 10px; }
        .btn-rec, .btn-play {
            width: 42px; height: 42px; border-radius: 50%; border: none;
            cursor: pointer; font-size: 1.2em; display: flex;
            justify-content: center; align-items: center; transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-rec { background: white; color: #ff6b6b; border: 2px solid #ff6b6b; }
        .btn-rec:hover { background: #ff6b6b; color: white; }
        .btn-rec.recording { background: #ff4b4b; color: white; animation: pulse 1.5s infinite; border-color: #ff4b4b; }
        .btn-play { background: white; color: #43e97b; border: 2px solid #43e97b; }
        .btn-play:hover { background: #43e97b; color: white; }
        .btn-play:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); border-color: #cbd5e0; color: #cbd5e0; background: #edf2f7; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0.7); } 70% { box-shadow: 0 0 0 12px rgba(255, 75, 75, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0); } }

        .input-box {
            font-size: 2em; padding: 12px; width: 90%; max-width: 350px;
            text-align: center; border: 3px solid #e2e8f0; border-radius: 15px;
            letter-spacing: 3px; margin-bottom: 8px; text-transform: lowercase;
            outline: none; flex-shrink: 0; align-self: center;
            background: #fff; color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Nunito', sans-serif; font-weight: 700;
        }
        .input-box:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2); }
        .input-box.correct { border-color: #43e97b; background-color: #f0fff4; color: #276749; }
        .input-box.wrong { border-color: #ff6b6b; background-color: #fff5f5; color: #c53030; animation: shake 0.5s; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        .controls { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
        .toggle-switch {
            display: flex; align-items: center; gap: 12px; font-size: 1.1em;
            background: #fff; padding: 8px 16px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .toggle-switch input { width: 18px; height: 18px; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(45, 55, 72, 0.6); backdrop-filter: blur(4px);
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; padding: 30px; border-radius: 25px;
            width: 90%; max-width: 500px; max-height: 80vh;
            overflow-y: auto; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .modal-content h2, .modal-content h3 { color: var(--text-color); }

        .store-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 15px; margin-top: 20px;
        }
        .store-item {
            border: 2px solid #e2e8f0; border-radius: 15px; padding: 12px;
            cursor: pointer; transition: all 0.2s; background: #fff;
        }
        .store-item:hover { border-color: var(--primary-color); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .store-item.owned { border-color: #43e97b; background: #f0fff4; }
        .store-item.locked { opacity: 0.6; filter: grayscale(1); background: #edf2f7; }
        .price-tag { color: #d69e2e; font-weight: bold; display: block; margin-top: 8px; font-size: 1em; }

        .combo-text {
            position: absolute; top: 25px; right: 25px; font-size: 2em;
            color: var(--accent-color); font-weight: 800; opacity: 0;
            transform: scale(0.5); transition: all 0.3s; pointer-events: none;
            text-shadow: 2px 2px 0px white, 4px 4px 10px rgba(0,0,0,0.2); z-index: 20;
        }
        .combo-text.show { opacity: 1; transform: scale(1.2) rotate(-10deg); }

        .btn {
            padding: 12px 30px; border-radius: 30px; border: none;
            cursor: pointer; font-size: 1.1em; font-weight: bold;
            background: linear-gradient(to right, var(--primary-color), #5a67d8);
            color: white; margin-top: 10px; flex-shrink: 0; align-self: center;
            box-shadow: 0 4px 12px rgba(90, 103, 216, 0.4); transition: all 0.2s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(90, 103, 216, 0.5); }
        .btn:active { transform: translateY(1px); box-shadow: 0 2px 5px rgba(90, 103, 216, 0.4); }

        /* Login Screen */
        #loginScreen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            z-index: 6000; display: flex; justify-content: center; align-items: center;
        }
        .login-grid { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; width: 100%; }
        .btn-login { 
            padding: 18px; font-size: 1.4em; border-radius: 20px; border: none; 
            background: white; box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
            cursor: pointer; transition: all 0.2s; font-weight: 800; 
            color: var(--text-color); display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        .btn-login:hover { transform: scale(1.05); color: var(--primary-color); }
        .btn-login:active { transform: scale(0.98); }

        /* Sync Status Icon */
        #syncStatus {
            position: fixed; bottom: 15px; right: 15px; 
            background: rgba(255,255,255,0.8); padding: 5px 10px; 
            border-radius: 15px; font-size: 0.8em; color: #718096;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); pointer-events: none;
            display: flex; align-items: center; gap: 5px; opacity: 0; transition: opacity 0.3s;
        }
        #syncStatus.visible { opacity: 1; }

        /* Loading Screen */
        #loadingScreen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: white; z-index: 5000; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-height: 600px) {
            header { padding: 8px 15px; }
            .game-card { padding: 15px; }
            .btn-audio { width: 45px; height: 45px; font-size: 20px; }
            .word-info-card { max-height: 25vh; font-size: 0.9em; padding: 10px 15px; }
            .input-box { margin-bottom: 5px; font-size: 1.6em; padding: 8px; }
            .btn { padding: 8px 20px; font-size: 1em; }
        }
    </style>
</head>
<body>

<div id="loadingScreen" style="display:none;">
    <div class="spinner"></div>
    <div style="color: #4a5568; font-weight: bold;">é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>
</div>

<!-- ç™»å…¥é¸æ“‡ç•«é¢ -->
<div id="loginScreen" class="modal active" style="display: flex;">
    <div class="modal-content" style="background: rgba(255,255,255,0.95); max-width: 400px;">
        <h2 style="color: var(--primary-color); font-size: 2em; margin-bottom: 10px;">ğŸ‘‹ æ­¡è¿å›ä¾†</h2>
        <p style="font-size: 1.2em; color: #718096;">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†ï¼š</p>
        <div class="login-grid">
            <button class="btn-login" onclick="login('Pierce')">ğŸ‘¦ Pierce</button>
            <button class="btn-login" onclick="login('Allen')">ğŸ§‘ Allen</button>
            <button class="btn-login" onclick="login('James')">ğŸ‘¨ James</button>
        </div>
    </div>
</div>

<header>
    <div class="user-info" onclick="showLogoutOption()" title="é»æ“Šç™»å‡º">
        <div class="avatar" id="currentAvatar">ğŸ‘¦</div>
        <div>
            <div id="userTitle">åˆå­¸æ–°æ‰‹</div>
            <div style="font-size: 0.8em; opacity: 0.8;">ç­‰ç´š <span id="level">1</span> <span id="usernameDisplay" style="font-weight:normal; margin-left:5px; background:rgba(255,255,255,0.2); padding:0 5px; border-radius:5px;"></span></div>
        </div>
    </div>
    
    <div class="stats-bar">
        <span>ğŸ’° <span id="tokens" class="currency">0</span></span>
    </div>

    <button class="btn-store" onclick="openStore()">ğŸ›’ å•†åŸ</button>
</header>

<main>
    <div class="game-card">
        <div id="setupScreen">
            <h2>ğŸ“š è«‹é¸æ“‡ç·´ç¿’ç¯„åœ</h2>
            <div class="category-select" id="categoryList"></div>
            
            <div class="controls">
                <label class="toggle-switch">
                    <input type="checkbox" id="randomMode"> éš¨æ©Ÿé †åº
                </label>
            </div>
            <button class="btn" style="width: 100%; max-width: 350px; font-size: 1.3em; margin-top:30px;" onclick="startGame()">é–‹å§‹ç·´ç¿’ â–¶</button>
        </div>

        <div id="gameArea" class="game-area">
            <button class="btn-back" onclick="quitGame()">â¬… è¿”å›åˆ—è¡¨</button>
            
            <div class="combo-text" id="comboDisplay">COMBO x2!</div>
            
            <div class="progress-hud">
                <span>âœ… ç­”å°: <span id="scoreCorrect">0</span></span>
                <span>âŒ ç­”éŒ¯: <span id="scoreWrong">0</span></span>
                <span>å‰©é¤˜: <span id="wordsLeft">0</span></span>
            </div>

            <div class="timer" id="timerDisplay">00:00</div>

            <div class="audio-controls">
                <button class="btn-audio" onclick="playCurrentWord(0)" title="æ¨™æº–ç™¼éŸ³">ğŸ”Š</button>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button class="btn-audio secondary" onclick="playCurrentWord(1)" title="æ…¢é€Ÿæ©Ÿå™¨äºº">ğŸ¤–</button>
                    <button class="btn-audio secondary" onclick="playCurrentWord(2)" title="é«˜éŸ³æ¾é¼ ">ğŸ¿ï¸</button>
                </div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                     <button class="btn-audio secondary" onclick="playCurrentWord(3)" title="ä½æ²‰è²éŸ³">ğŸ¦</button>
                     <button class="btn-audio text-btn" onclick="playSentence()" title="æœ—è®€ä¾‹å¥">ğŸ—£ï¸ å”¸ä¾‹å¥</button>
                </div>
            </div>

            <div class="recording-container">
                <div class="rec-status" id="recStatus">éŒ„éŸ³ç·´ç¿’</div>
                <div class="rec-controls">
                    <button class="btn-rec" id="recordBtn" onclick="toggleRecording()" title="é–‹å§‹/åœæ­¢éŒ„éŸ³">ğŸ¤</button>
                    <button class="btn-play" id="playRecordBtn" onclick="playUserRecording()" disabled title="æ’­æ”¾éŒ„éŸ³">â–¶ï¸</button>
                </div>
            </div>

            <input type="text" id="answerInput" class="input-box" placeholder="è¼¸å…¥å–®å­—..." autocomplete="off">
            
            <div id="feedback" style="height: 20px; color: #e53e3e; font-weight: bold; margin-bottom: 8px; font-size: 1em; flex-shrink: 0;"></div>

            <button id="submitBtn" class="btn" onclick="checkAnswer()">é€å‡ºç­”æ¡ˆ (Enter)</button>
            <button id="nextBtn" class="btn" style="display:none; background: linear-gradient(to right, #48bb78, #38a169);" onclick="nextWord()">ä¸‹ä¸€é¡Œ â–¶</button>

            <div class="word-info-card">
                <div class="word-pos" id="displayPos"></div>
                <div class="word-meaning" id="displayMeaning"></div>
                <div class="word-definition" id="displayDef"></div>
                <div class="word-sentence" id="displaySentence"></div>
            </div>
        </div>

        <div id="resultScreen" style="display:none; flex:1; flex-direction:column; justify-content:center;">
            <h2 style="font-size: 2.2em; color: var(--text-color);">ğŸ‰ ç·´ç¿’å®Œæˆï¼</h2>
            <p style="font-size: 1.2em;">æœ¬æ¬¡å¾—åˆ†: <span id="finalScore" style="font-size:2.5em; color:var(--primary-color); font-weight:800;">0</span></p>
            <p style="font-size: 1.1em; color: #718096;">è€—æ™‚: <span id="finalTime" style="font-weight:bold;">00:00</span></p>
            <p style="font-size: 1.2em;">ç²å¾—ä»£å¹£: <span style="color:#d69e2e; font-weight:bold;">+<span id="earnedTokens">0</span> ğŸ’°</span></p>
            <div id="wrongWordsArea" style="text-align:left; margin-top:25px; display:none; max-height: 30vh; overflow-y: auto; background: #fff; padding: 15px; border-radius: 15px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);">
                <h4 style="color:#e53e3e; margin-top:0;">éœ€åŠ å¼·çš„å–®å­—ï¼š</h4>
                <ul id="wrongWordsList" style="padding-left: 20px; color: #4a5568;"></ul>
                <button class="btn" style="background: linear-gradient(to right, #f56565, #e53e3e); margin-top: 15px; box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);" onclick="retryWrong()">éŒ¯é¡Œé‡ç·´</button>
            </div>
            <button class="btn" style="margin-top: 20px;" onclick="location.reload()">å›åˆ°é¦–é </button>
        </div>
    </div>
</main>

<div id="syncStatus">â˜ï¸ å·²åŒæ­¥</div>

<!-- å•†åŸ Modal -->
<div id="storeModal" class="modal">
    <div class="modal-content">
        <h2>ğŸ›ï¸ å­¸ç¿’å•†åŸ</h2>
        <p style="font-size: 1.2em;">ç›®å‰æŒæœ‰: <span id="storeTokens" class="currency">0</span> ğŸ’°</p>
        
        <h3 style="margin-top: 20px; text-align: left; border-bottom: 2px solid #edf2f7; padding-bottom: 5px;">ğŸ‘¤ é ­åƒ</h3>
        <div class="store-grid" id="avatarStore"></div>

        <h3 style="margin-top: 20px; text-align: left; border-bottom: 2px solid #edf2f7; padding-bottom: 5px;">ğŸ¨ ä¸»é¡Œ</h3>
        <div class="store-grid" id="themeStore"></div>

        <h3 style="margin-top: 20px; text-align: left; border-bottom: 2px solid #edf2f7; padding-bottom: 5px;">ğŸ”Š éŸ³æ•ˆåŒ…</h3>
        <div class="store-grid" id="sfxStore"></div>

        <button class="btn" style="margin-top:25px; background: #a0aec0; box-shadow: none;" onclick="document.getElementById('storeModal').classList.remove('active')">é—œé–‰</button>
    </div>
</div>

<!-- é€šç”¨è¨Šæ¯/ç¢ºèªå½ˆçª— -->
<div id="msgModal" class="modal" style="z-index: 7000;">
    <div class="modal-content" style="max-width: 380px;">
        <h3 id="msgTitle" style="font-size: 1.5em; margin-bottom: 10px;">æç¤º</h3>
        <p id="msgContent" style="margin: 15px 0; font-size: 1.2em; color: #4a5568; line-height: 1.5;"></p>
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
            <button id="msgCancelBtn" class="btn" style="background: #cbd5e0; color: #4a5568; display:none; box-shadow: none;">å–æ¶ˆ</button>
            <button id="msgOkBtn" class="btn">ç¢ºå®š</button>
        </div>
    </div>
</div>

<script>
    // ******************************************************
    // é‡è¦ï¼šè«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
    const GAS_URL = "https://script.google.com/macros/s/AKfycby98J3n-Nz2F1HQQDb7hw8VheYC-SnitjlUFVO8k2VT4kayjFsT9wLYNHAAGUT1yMeS/exec"; 
    // ******************************************************

    // --- è‡ªè£½å½ˆçª—ç³»çµ± ---
    let msgCallback = null;

    function closeMsgModal() {
        document.getElementById('msgModal').classList.remove('active');
        document.getElementById('msgCancelBtn').style.display = 'none';
        msgCallback = null;
    }

    function showAlert(msg) {
        document.getElementById('msgTitle').innerText = "æç¤º";
        document.getElementById('msgContent').innerText = msg;
        document.getElementById('msgOkBtn').onclick = closeMsgModal;
        document.getElementById('msgModal').classList.add('active');
    }

    function showConfirm(msg, onYes) {
        document.getElementById('msgTitle').innerText = "ç¢ºèª";
        document.getElementById('msgContent').innerText = msg;
        document.getElementById('msgCancelBtn').style.display = 'inline-block';
        
        document.getElementById('msgCancelBtn').onclick = closeMsgModal;
        document.getElementById('msgOkBtn').onclick = () => {
            closeMsgModal();
            if(onYes) onYes();
        };
        
        document.getElementById('msgModal').classList.add('active');
    }

    function updateSyncStatus(status) {
        const el = document.getElementById('syncStatus');
        if (status === 'saving') {
            el.innerText = "â³ åŒæ­¥ä¸­...";
            el.classList.add('visible');
        } else if (status === 'saved') {
            el.innerText = "â˜ï¸ å·²åŒæ­¥";
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 2000);
        } else if (status === 'error') {
            el.innerText = "âš ï¸ åŒæ­¥å¤±æ•— (é›¢ç·šæ¨¡å¼)";
            el.style.color = "red";
            el.classList.add('visible');
        }
    }

    // --- è³‡æ–™åº« (100å–®å­—è©³ç´°è³‡æ–™) ---
    const wordBanks = {
        part1: { title: "Part 1", desc: "å–®å­— 1-25", data: [
            { word: "accompany", pos: "(v.)", meaning: "é™ªä¼´ï¼›ä¼´éš¨", enDef: "To go somewhere with someone.", sentence: "I will accompany my grandmother to the doctor tomorrow.", cnSentence: "æˆ‘æ˜å¤©æœƒé™ªç¥–æ¯å»çœ‹é†«ç”Ÿã€‚" },
            { word: "alder", pos: "(n.)", meaning: "æ¦¿æœ¨", enDef: "A type of tree that often grows near water.", sentence: "The bird built a small nest in the tall alder tree.", cnSentence: "é‚£éš»é³¥åœ¨é‚£æ£µé«˜å¤§çš„æ¦¿æœ¨ä¸Šç¯‰äº†ä¸€å€‹å°å·¢ã€‚" },
            { word: "adventure", pos: "(n.)", meaning: "å†’éšª", enDef: "An exciting and sometimes dangerous experience.", sentence: "Life is full of surprises and adventures if you are brave enough.", cnSentence: "å¦‚æœä½ å¤ å‹‡æ•¢ï¼Œç”Ÿæ´»ä¸­å……æ»¿äº†é©šå–œèˆ‡å†’éšªã€‚" },
            { word: "amphibian", pos: "(n.)", meaning: "å…©æ£²å‹•ç‰©", enDef: "An animal (like a frog) that can live both on land and in water.", sentence: "Frogs are the most common type of amphibian found in this area.", cnSentence: "é’è›™æ˜¯é€™å€‹åœ°å€æœ€å¸¸è¦‹çš„å…©æ£²å‹•ç‰©ã€‚" },
            { word: "ancient", pos: "(adj.)", meaning: "å¤ä»£çš„ï¼›å¤è€çš„", enDef: "Very old; from a long time ago.", sentence: "We visited the ancient ruins in Rome during our summer vacation.", cnSentence: "æˆ‘å€‘åœ¨æš‘å‡æœŸé–“åƒè§€äº†ç¾…é¦¬çš„å¤ä»£éºè·¡ã€‚" },
            { word: "appeal", pos: "(v./n.)", meaning: "å¸å¼•ï¼›å‘¼ç±²", enDef: "To be interesting or attractive to someone.", sentence: "The idea of camping in the rain doesn't appeal to me at all.", cnSentence: "åœ¨é›¨ä¸­éœ²ç‡Ÿçš„æƒ³æ³•å°æˆ‘ä¸€é»å¸å¼•åŠ›éƒ½æ²’æœ‰ã€‚" },
            { word: "appoint", pos: "(v.)", meaning: "æŒ‡æ´¾ï¼›ä»»å‘½", enDef: "To choose someone for a job or position.", sentence: "The teacher decided to appoint John as the class leader.", cnSentence: "è€å¸«æ±ºå®šæŒ‡æ´¾ç´„ç¿°æ“”ä»»ç­é•·ã€‚" },
            { word: "arithmetic", pos: "(n.)", meaning: "ç®—è¡“", enDef: "The math of adding, subtracting, multiplying, and dividing numbers.", sentence: "Mental arithmetic is a very useful skill for shopping.", cnSentence: "å¿ƒç®—å°æ–¼è³¼ç‰©ä¾†èªªæ˜¯ä¸€é …å¾ˆæœ‰ç”¨çš„æŠ€èƒ½ã€‚" },
            { word: "arrangement", pos: "(n.)", meaning: "å®‰æ’ï¼›ä½ˆç½®", enDef: "The way things are organized or placed.", sentence: "The flower arrangement on the table looks absolutely beautiful.", cnSentence: "æ¡Œä¸Šçš„èŠ±è—ä½ˆç½®çœ‹èµ·ä¾†ç¾æ¥µäº†ã€‚" },
            { word: "atop", pos: "(prep.)", meaning: "åœ¨...é ‚ä¸Š", enDef: "On the top of something.", sentence: "The cat sat atop the wall, watching the birds fly by.", cnSentence: "è²“å’ªååœ¨ç‰†é ­ä¸Šï¼Œçœ‹è‘—é³¥å…’é£›éã€‚" },
            { word: "automobile", pos: "(n.)", meaning: "æ±½è»Š", enDef: "A car.", sentence: "The invention of the automobile changed how people travel.", cnSentence: "æ±½è»Šçš„ç™¼æ˜æ”¹è®Šäº†äººå€‘æ—…è¡Œçš„æ–¹å¼ã€‚" },
            { word: "awaken", pos: "(v.)", meaning: "å–šé†’ï¼›é†’ä¾†", enDef: "To wake someone up.", sentence: "Please be quiet, or you might awaken the sleeping baby.", cnSentence: "è«‹å®‰éœï¼Œå¦å‰‡ä½ å¯èƒ½æœƒåµé†’ç¡è‘—çš„å¬°å…’ã€‚" },
            { word: "barnacle", pos: "(n.)", meaning: "è—¤å£º", enDef: "A small sea animal with a hard shell that sticks to rocks and ships.", sentence: "Many barnacles were attached to the bottom of the old boat.", cnSentence: "è¨±å¤šè—¤å£ºé™„è‘—åœ¨é‚£è‰˜èˆŠèˆ¹çš„åº•éƒ¨ã€‚" },
            { word: "beneficial", pos: "(adj.)", meaning: "æœ‰ç›Šçš„", enDef: "Helpful or good for you.", sentence: "Eating plenty of vegetables is beneficial to your health.", cnSentence: "å¤šåƒè”¬èœå°ä½ çš„å¥åº·æœ‰ç›Šã€‚" },
            { word: "bewilder", pos: "(v.)", meaning: "ä½¿è¿·æƒ‘", enDef: "To confuse someone very much.", sentence: "The complicated map completely bewildered the tourists.", cnSentence: "é€™å¼µè¤‡é›œçš„åœ°åœ–è®“éŠå®¢å€‘å®Œå…¨æç³Šå¡—äº†ã€‚" },
            { word: "bulletin", pos: "(n.)", meaning: "å…¬å‘Šï¼›å¿«å ±", enDef: "A short official statement or news report.", sentence: "Check the school bulletin board for the exam schedule.", cnSentence: "è«‹æŸ¥çœ‹å­¸æ ¡ä½ˆå‘Šæ¬„ä¸Šçš„è€ƒè©¦æ™‚é–“è¡¨ã€‚" },
            { word: "calories", pos: "(n.)", meaning: "å¡è·¯é‡Œ", enDef: "Units used to measure the energy in food.", sentence: "She counts calories carefully because she wants to stay healthy.", cnSentence: "å¥¹ä»”ç´°è¨ˆç®—å¡è·¯é‡Œï¼Œå› ç‚ºå¥¹æƒ³ä¿æŒå¥åº·ã€‚" },
            { word: "cattle", pos: "(n.)", meaning: "ç‰›ç¾¤", enDef: "Cows and bulls kept on a farm.", sentence: "The farmer raises cattle for both milk and meat.", cnSentence: "é‚£ä½è¾²å¤«é£¼é¤Šç‰›ç¾¤ä»¥ç²å–ç‰›å¥¶å’Œç‰›è‚‰ã€‚" },
            { word: "central", pos: "(adj.)", meaning: "ä¸­å¤®çš„", enDef: "In the middle of something.", sentence: "The park is located in the central part of the city.", cnSentence: "é€™åº§å…¬åœ’ä½æ–¼åŸå¸‚çš„ä¸­å¿ƒåœ°å¸¶ã€‚" },
            { word: "citizen", pos: "(n.)", meaning: "å…¬æ°‘", enDef: "A person who is a member of a country.", sentence: "Every citizen has the right to vote in the election.", cnSentence: "æ¯ä½å…¬æ°‘éƒ½æœ‰æ¬Šåˆ©åœ¨é¸èˆ‰ä¸­æŠ•ç¥¨ã€‚" },
            { word: "compel", pos: "(v.)", meaning: "å¼·è¿«", enDef: "To force someone to do something.", sentence: "The heavy rain compelled us to cancel the picnic and stay indoors.", cnSentence: "å¤§é›¨è¿«ä½¿æˆ‘å€‘å–æ¶ˆé‡é¤ä¸¦å¾…åœ¨å®¤å…§ã€‚" },
            { word: "conclude", pos: "(v.)", meaning: "ä¸‹çµè«–ï¼›çµæŸ", enDef: "To end a speech, meeting, or piece of writing.", sentence: "The principal concluded his speech with a famous quote.", cnSentence: "æ ¡é•·å¼•ç”¨ä¸€å¥åè¨€çµæŸäº†ä»–çš„æ¼”è¬›ã€‚" },
            { word: "condor", pos: "(n.)", meaning: "ç¦¿é·¹ï¼›ç¥é·¹", enDef: "A very large bird that eats dead animals.", sentence: "We were lucky enough to see a giant condor flying over the mountains.", cnSentence: "æˆ‘å€‘å¾ˆå¹¸é‹åœ°çœ‹åˆ°ä¸€éš»å·¨å¤§çš„ç¦¿é·¹é£›è¶Šå±±é ­ã€‚" },
            { word: "consist", pos: "(v.)", meaning: "çµ„æˆ", enDef: "To be made of particular parts or things.", sentence: "A soccer team usually consists of eleven players.", cnSentence: "ä¸€æ”¯è¶³çƒéšŠé€šå¸¸ç”±åä¸€åçƒå“¡çµ„æˆã€‚" },
            { word: "contract", pos: "(n.)", meaning: "åˆç´„ï¼›(v.) æ”¶ç¸®", enDef: "An official written agreement.", sentence: "My dad signed a two-year contract for his new job.", cnSentence: "æˆ‘çˆ¸çˆ¸ç‚ºä»–çš„æ–°å·¥ä½œç°½äº†ä¸€ä»½å…©å¹´çš„åˆç´„ã€‚" }
        ]},
        part2: { title: "Part 2", desc: "å–®å­— 26-50", data: [
            { word: "courtroom", pos: "(n.)", meaning: "æ³•åº­", enDef: "A room where legal cases are judged.", sentence: "Everyone stood up when the judge entered the courtroom.", cnSentence: "ç•¶æ³•å®˜é€²å…¥æ³•åº­æ™‚ï¼Œæ¯å€‹äººéƒ½ç«™äº†èµ·ä¾†ã€‚" },
            { word: "current", pos: "(adj.)", meaning: "ç›®å‰çš„", enDef: "Happening or existing now.", sentence: "The current situation is difficult, but we will solve it.", cnSentence: "ç›®å‰çš„æƒ…æ³å¾ˆå›°é›£ï¼Œä½†æˆ‘å€‘æœƒè§£æ±ºå®ƒçš„ã€‚" },
            { word: "decorate", pos: "(v.)", meaning: "è£é£¾", enDef: "To make something look nicer by adding things to it.", sentence: "Let's decorate the living room with balloons for the party.", cnSentence: "æˆ‘å€‘ç”¨æ°£çƒä¾†è£é£¾å®¢å»³èˆ‰è¾¦æ´¾å°å§ã€‚" },
            { word: "diary", pos: "(n.)", meaning: "æ—¥è¨˜", enDef: "A book in which you write down your daily thoughts and experiences.", sentence: "Keeping a diary helps me remember special moments in my life.", cnSentence: "å¯«æ—¥è¨˜å¹«åŠ©æˆ‘è¨˜ä½ç”Ÿå‘½ä¸­çš„ç‰¹æ®Šæ™‚åˆ»ã€‚" },
            { word: "double", pos: "(adj.)", meaning: "é›™å€çš„", enDef: "Twice as big or twice as much.", sentence: "I ordered a double cheeseburger because I was very hungry.", cnSentence: "æˆ‘é»äº†ä¸€å€‹é›™å±¤èµ·å¸æ¼¢å ¡ï¼Œå› ç‚ºæˆ‘éå¸¸é¤“ã€‚" },
            { word: "effect", pos: "(n.)", meaning: "å½±éŸ¿ï¼›æ•ˆæœ", enDef: "A change that is caused by something.", sentence: "Air pollution has a serious negative effect on the environment.", cnSentence: "ç©ºæ°£æ±¡æŸ“å°ç’°å¢ƒæœ‰åš´é‡çš„è² é¢å½±éŸ¿ã€‚" },
            { word: "entire", pos: "(adj.)", meaning: "æ•´å€‹çš„", enDef: "Whole or complete.", sentence: "He was so hungry that he ate the entire pizza by himself.", cnSentence: "ä»–é¤“åˆ°è‡ªå·±ä¸€å€‹äººåƒæ‰äº†æ•´å€‹æŠ«è–©ã€‚" },
            { word: "entrance", pos: "(n.)", meaning: "å…¥å£", enDef: "A door or gate used to go into a place.", sentence: "The main entrance to the museum is around the corner.", cnSentence: "åšç‰©é¤¨çš„æ­£é–€åœ¨è½‰è§’è™•ã€‚" },
            { word: "exist", pos: "(v.)", meaning: "å­˜åœ¨", enDef: "To be real or present.", sentence: "Do you believe that aliens really exist in the universe?", cnSentence: "ä½ ç›¸ä¿¡å®‡å®™ä¸­çœŸçš„å­˜åœ¨å¤–æ˜Ÿäººå—ï¼Ÿ" },
            { word: "expense", pos: "(n.)", meaning: "èŠ±è²»ï¼›é–‹æ”¯", enDef: "Money that you spend on something.", sentence: "Buying a new house is a huge expense for most families.", cnSentence: "å°å¤§å¤šæ•¸å®¶åº­ä¾†èªªï¼Œè²·æ–°æˆ¿æ˜¯ä¸€ç­†å·¨å¤§çš„é–‹éŠ·ã€‚" },
            { word: "experiment", pos: "(n.)", meaning: "å¯¦é©—", enDef: "A scientific test to learn something new.", sentence: "The science experiment showed how water turns into ice.", cnSentence: "é€™å€‹ç§‘å­¸å¯¦é©—å±•ç¤ºäº†æ°´å¦‚ä½•è®Šæˆå†°ã€‚" },
            { word: "falter", pos: "(v.)", meaning: "çŒ¶è±«ï¼›å‹•æ–", enDef: "To become weak or unsure.", sentence: "His voice faltered when he had to tell the sad news.", cnSentence: "ç•¶ä»–å¿…é ˆèªªå‡ºé€™å€‹æ‚²å‚·çš„æ¶ˆæ¯æ™‚ï¼Œä»–çš„è²éŸ³é¡«æŠ–äº†ã€‚" },
            { word: "faraway", pos: "(adj.)", meaning: "é™é çš„", enDef: "A long distance away.", sentence: "She dreams of traveling to faraway lands and meeting new people.", cnSentence: "å¥¹å¤¢æƒ³è‘—å»é™é çš„åœ‹åº¦æ—…è¡Œä¸¦çµè­˜æ–°æœ‹å‹ã€‚" },
            { word: "fitness", pos: "(n.)", meaning: "å¥åº·ï¼›é«”èƒ½", enDef: "The condition of being physically strong and healthy.", sentence: "Regular exercise is essential for physical fitness.", cnSentence: "è¦å¾‹é‹å‹•å°æ–¼èº«é«”å¥åº·æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚" },
            { word: "fashion", pos: "(n.)", meaning: "æ™‚å°šï¼›æµè¡Œ", enDef: "A popular style of clothes, hair, etc.", sentence: "Blue jeans never seem to go out of fashion.", cnSentence: "è—è‰²ç‰›ä»”è¤²ä¼¼ä¹æ°¸é ä¸æœƒé€€æµè¡Œã€‚" },
            { word: "forever", pos: "(adv.)", meaning: "æ°¸é ", enDef: "For all time.", sentence: "I will remember this wonderful trip forever.", cnSentence: "æˆ‘å°‡æ°¸é è¨˜å¾—é€™è¶Ÿç¾å¥½çš„æ—…ç¨‹ã€‚" },
            { word: "footstep", pos: "(n.)", meaning: "è…³æ­¥è²", enDef: "The sound of a person walking.", sentence: "I heard heavy footsteps coming down the hallway.", cnSentence: "æˆ‘è½åˆ°æ²‰é‡çš„è…³æ­¥è²å¾èµ°å»Šå‚³ä¾†ã€‚" },
            { word: "furniture", pos: "(n.)", meaning: "å‚¢ä¿±", enDef: "Large objects like tables, chairs, and beds used in a room.", sentence: "We need to buy some new furniture for our new apartment.", cnSentence: "æˆ‘å€‘éœ€è¦ç‚ºæ–°å…¬å¯“è²·ä¸€äº›æ–°å‚¢ä¿±ã€‚" },
            { word: "glacier", pos: "(n.)", meaning: "å†°æ²³", enDef: "A large mass of ice that moves slowly.", sentence: "Global warming is causing glaciers to melt rapidly.", cnSentence: "å…¨çƒæš–åŒ–æ­£å°è‡´å†°æ²³è¿…é€ŸèåŒ–ã€‚" },
            { word: "glance", pos: "(v.)", meaning: "ç¥ä¸€çœ¼", enDef: "To look quickly at something.", sentence: "He glanced at his watch and realized he was late for school.", cnSentence: "ä»–ç¥äº†ä¸€çœ¼æ‰‹éŒ¶ï¼Œç™¼ç¾ä¸Šå­¸è¦é²åˆ°äº†ã€‚" },
            { word: "gloom", pos: "(n.)", meaning: "æ†‚é¬±ï¼›é™°æš—", enDef: "A feeling of sadness or a dark and dim state.", sentence: "The gloom of the rainy afternoon made everyone feel sleepy.", cnSentence: "ä¸‹é›¨åˆå¾Œçš„é™°æ²‰è®“æ¯å€‹äººéƒ½è¦ºå¾—æƒ³ç¡ã€‚" },
            { word: "greenery", pos: "(n.)", meaning: "ç¶ è‰²æ¤ç‰©", enDef: "Green plants or leaves.", sentence: "The park is full of lush greenery and colorful flowers.", cnSentence: "å…¬åœ’è£¡å……æ»¿äº†èŒ‚ç››çš„ç¶ è‰²æ¤ç‰©å’Œè‰²å½©ç¹½ç´›çš„èŠ±æœµã€‚" },
            { word: "gross", pos: "(adj.)", meaning: "å™å¿ƒçš„", enDef: "Very unpleasant or disgusting.", sentence: "\"Eww, that dead bug is gross!\" shouted the little boy.", cnSentence: "ã€Œå™ï¼Œé‚£éš»æ­»èŸ²å¥½å™å¿ƒï¼ã€å°ç”·å­©å¤§å«é“ã€‚" },
            { word: "hectic", pos: "(adj.)", meaning: "å¿™äº‚çš„", enDef: "Very busy and fast.", sentence: "Life in a big city can be very hectic and stressful.", cnSentence: "å¤§åŸå¸‚çš„ç”Ÿæ´»å¯èƒ½æœƒéå¸¸å¿™äº‚ä¸”å……æ»¿å£“åŠ›ã€‚" },
            { word: "hence", pos: "(adv.)", meaning: "å› æ­¤", enDef: "For this reason.", sentence: "It is raining heavily; hence, the soccer game is canceled.", cnSentence: "é›¨ä¸‹å¾—å¾ˆå¤§ï¼Œå› æ­¤è¶³çƒè³½å–æ¶ˆäº†ã€‚" }
        ]},
        part3: { title: "Part 3", desc: "å–®å­— 51-75", data: [
            { word: "herald", pos: "(v.)", meaning: "é ç¤º", enDef: "To be a sign that something is going to happen.", sentence: "The arrival of the cuckoo bird often heralds the start of spring.", cnSentence: "æœéµ‘é³¥çš„åˆ°ä¾†é€šå¸¸é ç¤ºè‘—æ˜¥å¤©çš„é–‹å§‹ã€‚" },
            { word: "hockey", pos: "(n.)", meaning: "æ›²æ£çƒ", enDef: "A sport played on ice or a field with sticks and a puck/ball.", sentence: "Ice hockey is a very popular sport in Canada.", cnSentence: "å†°ä¸Šæ›²æ£çƒåœ¨åŠ æ‹¿å¤§æ˜¯éå¸¸å—æ­¡è¿çš„é‹å‹•ã€‚" },
            { word: "housekeeper", pos: "(n.)", meaning: "ç®¡å®¶", enDef: "A person paid to clean and look after a house.", sentence: "The housekeeper ensures that all the rooms in the hotel are clean.", cnSentence: "æˆ¿å‹™ç®¡å®¶ç¢ºä¿é£¯åº—è£¡æ‰€æœ‰çš„æˆ¿é–“éƒ½æ˜¯ä¹¾æ·¨çš„ã€‚" },
            { word: "ideal", pos: "(adj.)", meaning: "ç†æƒ³çš„", enDef: "Perfect; the best possible.", sentence: "A sunny day with a light breeze is ideal for a picnic.", cnSentence: "é™½å…‰æ™®ç…§ä¸”æœ‰å¾®é¢¨çš„æ—¥å­æ˜¯é‡é¤çš„ç†æƒ³å¤©æ°£ã€‚" },
            { word: "increase", pos: "(v./n.)", meaning: "å¢åŠ ", enDef: "To become larger or greater in amount.", sentence: "The price of vegetables tends to increase after a typhoon.", cnSentence: "é¢±é¢¨éå¾Œè”¬èœåƒ¹æ ¼å¾€å¾€æœƒä¸Šæ¼²ã€‚" },
            { word: "individual", pos: "(n.)", meaning: "å€‹äºº", enDef: "A single person or thing.", sentence: "Each individual has a unique fingerprint.", cnSentence: "æ¯å€‹äººéƒ½æœ‰ç¨ä¸€ç„¡äºŒçš„æŒ‡ç´‹ã€‚" },
            { word: "instant", pos: "(adj.)", meaning: "ç«‹å³çš„", enDef: "Happening immediately.", sentence: "I sent him a message and got an instant reply.", cnSentence: "æˆ‘å‚³è¨Šæ¯çµ¦ä»–ï¼Œä¸¦å¾—åˆ°äº†ç«‹å³çš„å›è¦†ã€‚" },
            { word: "ivory", pos: "(n.)", meaning: "è±¡ç‰™", enDef: "The hard white substance from elephant tusks.", sentence: "Trading ivory is illegal in many countries to protect elephants.", cnSentence: "ç‚ºäº†ä¿è­·å¤§è±¡ï¼Œåœ¨è¨±å¤šåœ‹å®¶è²·è³£è±¡ç‰™æ˜¯éæ³•çš„ã€‚" },
            { word: "journey", pos: "(n.)", meaning: "æ—…ç¨‹", enDef: "A long trip from one place to another.", sentence: "The journey to the top of the mountain took us five hours.", cnSentence: "å‰å¾€å±±é ‚çš„æ—…ç¨‹èŠ±äº†æˆ‘å€‘äº”å€‹å°æ™‚ã€‚" },
            { word: "justice", pos: "(n.)", meaning: "æ­£ç¾©", enDef: "Fairness; right behavior.", sentence: "Superheroes in movies always fight for justice.", cnSentence: "é›»å½±è£¡çš„è¶…ç´šè‹±é›„ç¸½æ˜¯ç‚ºäº†æ­£ç¾©è€Œæˆ°ã€‚" },
            { word: "league", pos: "(n.)", meaning: "è¯ç›Ÿ", enDef: "A group of sports teams that play against each other.", sentence: "My brother plays baseball in the local junior league.", cnSentence: "æˆ‘å“¥å“¥åœ¨ç•¶åœ°çš„å°‘å¹´è¯ç›Ÿæ‰“æ£’çƒã€‚" },
            { word: "liquid", pos: "(n.)", meaning: "æ¶²é«”", enDef: "A substance like water that flows freely.", sentence: "Water becomes a solid when it freezes and a liquid when it melts.", cnSentence: "æ°´çµå†°æ™‚è®Šæˆå›ºé«”ï¼ŒèåŒ–æ™‚è®Šæˆæ¶²é«”ã€‚" },
            { word: "livestock", pos: "(n.)", meaning: "å®¶ç•œ", enDef: "Animals kept on a farm, like cows and sheep.", sentence: "The farm has a lot of livestock, such as cows, sheep, and pigs.", cnSentence: "é€™å€‹è¾²å ´æœ‰å¾ˆå¤šå®¶ç•œï¼Œä¾‹å¦‚ç‰›ã€ç¾Šå’Œè±¬ã€‚" },
            { word: "major", pos: "(adj.)", meaning: "ä¸»è¦çš„ï¼›é‡å¤§çš„", enDef: "Very large, important, or serious.", sentence: "Pollution is a major problem that we need to solve.", cnSentence: "æ±¡æŸ“æ˜¯æˆ‘å€‘éœ€è¦è§£æ±ºçš„ä¸€å€‹ä¸»è¦å•é¡Œã€‚" },
            { word: "memory", pos: "(n.)", meaning: "è¨˜æ†¶", enDef: "Something that you remember.", sentence: "I have a fond memory of baking cookies with my mom.", cnSentence: "æˆ‘æœ‰å€‹è·Ÿåª½åª½ä¸€èµ·çƒ¤é¤…ä¹¾çš„ç¾å¥½å›æ†¶ã€‚" },
            { word: "mere", pos: "(adj.)", meaning: "åƒ…åƒ…", enDef: "Only; used to emphasize how small something is.", sentence: "It took a mere five minutes to fix the toy.", cnSentence: "ä¿®å¥½é€™å€‹ç©å…·åƒ…åƒ…èŠ±äº†äº”åˆ†é˜ã€‚" },
            { word: "niece", pos: "(n.)", meaning: "å§ªå¥³ï¼›å¤–ç”¥å¥³", enDef: "The daughter of your brother or sister.", sentence: "My sister's daughter is my niece.", cnSentence: "æˆ‘å§å§çš„å¥³å…’æ˜¯æˆ‘çš„å¤–ç”¥å¥³ã€‚" },
            { word: "notify", pos: "(v.)", meaning: "é€šçŸ¥", enDef: "To tell someone officially about something.", sentence: "Please notify the teacher if you are going to be late.", cnSentence: "å¦‚æœä½ æœƒé²åˆ°ï¼Œè«‹é€šçŸ¥è€å¸«ã€‚" },
            { word: "obey", pos: "(v.)", meaning: "æœå¾", enDef: "To do what a rule or person says.", sentence: "Drivers must obey traffic rules to avoid accidents.", cnSentence: "é§•é§›å¿…é ˆéµå®ˆäº¤é€šè¦å‰‡ä»¥é¿å…æ„å¤–ã€‚" },
            { word: "onward", pos: "(adv.)", meaning: "å‘å‰", enDef: "Moving forward.", sentence: "Despite the rain, the hikers continued onward.", cnSentence: "å„˜ç®¡ä¸‹è‘—é›¨ï¼Œç™»å±±å®¢å€‘ä»ç¹¼çºŒå‘å‰è¡Œã€‚" },
            { word: "opinion", pos: "(n.)", meaning: "æ„è¦‹", enDef: "What you think about something.", sentence: "In my opinion, chocolate ice cream is the best flavor.", cnSentence: "ä¾æˆ‘çœ‹ï¼ˆä¾æˆ‘çš„æ„è¦‹ï¼‰ï¼Œå·§å…‹åŠ›å†°æ·‡æ·‹æ˜¯æœ€å¥½åƒçš„å£å‘³ã€‚" },
            { word: "oppose", pos: "(v.)", meaning: "åå°", enDef: "To disagree with something or try to stop it.", sentence: "Many people oppose the plan to build a factory near the park.", cnSentence: "è¨±å¤šäººåå°åœ¨å…¬åœ’é™„è¿‘è“‹å·¥å» çš„è¨ˆç•«ã€‚" },
            { word: "original", pos: "(adj.)", meaning: "æœ€åˆçš„", enDef: "Existing at the beginning.", sentence: "The original plan was better than the new one.", cnSentence: "æœ€åˆçš„è¨ˆç•«æ¯”æ–°çš„é€™å€‹å¥½ã€‚" },
            { word: "pattern", pos: "(n.)", meaning: "åœ–æ¡ˆ", enDef: "A repeated design or arrangement.", sentence: "I really like the floral pattern on your dress.", cnSentence: "æˆ‘çœŸçš„å¾ˆå–œæ­¡ä½ æ´‹è£ä¸Šçš„èŠ±æœµåœ–æ¡ˆã€‚" },
            { word: "personal", pos: "(adj.)", meaning: "å€‹äººçš„ï¼›ç§äººçš„", enDef: "Belonging to one person; not public.", sentence: "Please don't ask personal questions to people you just met.", cnSentence: "è«‹ä¸è¦å•å‰›èªè­˜çš„äººç§äººå•é¡Œã€‚" }
        ]},
        part4: { title: "Part 4", desc: "å–®å­— 76-100", data: [
            { word: "pleasant", pos: "(adj.)", meaning: "ä»¤äººæ„‰å¿«çš„", enDef: "Nice, enjoyable, or friendly.", sentence: "We had a pleasant walk in the park this morning.", cnSentence: "æˆ‘å€‘ä»Šå¤©æ—©ä¸Šåœ¨å…¬åœ’è£¡æ„‰å¿«åœ°æ•£æ­¥ã€‚" },
            { word: "polar", pos: "(adj.)", meaning: "æ¥µåœ°çš„", enDef: "Related to the North or South Pole.", sentence: "Polar bears have thick fur to keep them warm in the cold.", cnSentence: "åŒ—æ¥µç†Šæœ‰åšåšçš„æ¯›çš®è®“ç‰ å€‘åœ¨å¯’å†·ä¸­ä¿æš–ã€‚" },
            { word: "reserve", pos: "(v.)", meaning: "é å®š", enDef: "To book something to be used later.", sentence: "I need to call the restaurant to reserve a table for dinner.", cnSentence: "æˆ‘éœ€è¦æ‰“é›»è©±çµ¦é¤å»³é è¨‚æ™šé¤çš„ä½å­ã€‚" },
            { word: "rinse", pos: "(v.)", meaning: "æ²–æ´—", enDef: "To wash something with clean water.", sentence: "Remember to rinse the apple with water before you eat it.", cnSentence: "åƒè˜‹æœä¹‹å‰è¨˜å¾—ç”¨æ°´æ²–æ´—ä¸€ä¸‹ã€‚" },
            { word: "rustle", pos: "(v./n.)", meaning: "ç™¼å‡ºæ²™æ²™è²", enDef: "To make a soft sound like dry leaves moving.", sentence: "The dry leaves rustled in the wind.", cnSentence: "ä¹¾ç‡¥çš„è‘‰å­åœ¨é¢¨ä¸­ç™¼å‡ºæ²™æ²™è²ã€‚" },
            { word: "salary", pos: "(n.)", meaning: "è–ªæ°´", enDef: "Money paid to employees for their work.", sentence: "He is happy with his new job because the salary is good.", cnSentence: "ä»–å°æ–°å·¥ä½œå¾ˆæ»¿æ„ï¼Œå› ç‚ºè–ªæ°´å¾ˆä¸éŒ¯ã€‚" },
            { word: "society", pos: "(n.)", meaning: "ç¤¾æœƒ", enDef: "People living together in a community.", sentence: "We all have a responsibility to help the poor in our society.", cnSentence: "æˆ‘å€‘éƒ½æœ‰è²¬ä»»å¹«åŠ©ç¤¾æœƒä¸­çš„çª®äººã€‚" },
            { word: "standard", pos: "(n./adj.)", meaning: "æ¨™æº–", enDef: "A level of quality that is accepted as normal.", sentence: "This car meets all the safety standards.", cnSentence: "é€™è¼›è»Šç¬¦åˆæ‰€æœ‰çš„å®‰å…¨æ¨™æº–ã€‚" },
            { word: "surround", pos: "(v.)", meaning: "åŒ…åœ", enDef: "To be all around something.", sentence: "Tall mountains surround the small village.", cnSentence: "é«˜å±±ç’°ç¹è‘—é€™å€‹å°æ‘èŠã€‚" },
            { word: "sweater", pos: "(n.)", meaning: "æ¯›è¡£", enDef: "A warm piece of clothing usually made of wool.", sentence: "Put on a sweater if you feel cold outside.", cnSentence: "å¦‚æœä½ åœ¨å¤–é¢è¦ºå¾—å†·ï¼Œå°±ç©¿ä¸Šæ¯›è¡£ã€‚" },
            { word: "terrify", pos: "(v.)", meaning: "ä½¿ææ‡¼", enDef: "To scare someone very much.", sentence: "Spiders terrify my little sister; she screams whenever she sees one.", cnSentence: "èœ˜è››è®“æˆ‘å¦¹å¦¹å¾ˆå®³æ€•ï¼›åªè¦çœ‹åˆ°ä¸€éš»å¥¹å°±æœƒå°–å«ã€‚" },
            { word: "territory", pos: "(n.)", meaning: "é ˜åœŸï¼›åœ°ç›¤", enDef: "An area of land that belongs to a person or animal.", sentence: "Wolves mark their territory to keep other animals away.", cnSentence: "ç‹¼ç¾¤æœƒæ¨™è¨˜ç‰ å€‘çš„åœ°ç›¤ä»¥é˜²æ­¢å…¶ä»–å‹•ç‰©é è¿‘ã€‚" },
            { word: "theater", pos: "(n.)", meaning: "åŠ‡é™¢", enDef: "A building where movies or plays are shown.", sentence: "We went to the theater to watch the latest movie.", cnSentence: "æˆ‘å€‘å»é›»å½±é™¢çœ‹æœ€æ–°çš„é›»å½±ã€‚" },
            { word: "tongue", pos: "(n.)", meaning: "èˆŒé ­", enDef: "The soft part inside the mouth used for tasting and speaking.", sentence: "The doctor asked the patient to stick out his tongue.", cnSentence: "é†«ç”Ÿè«‹ç—…äººä¼¸å‡ºèˆŒé ­ã€‚" },
            { word: "tremble", pos: "(v.)", meaning: "é¡«æŠ–", enDef: "To shake slightly because of cold or fear.", sentence: "She began to tremble with cold after waiting in the snow.", cnSentence: "åœ¨é›ªä¸­ç­‰å¾…å¾Œï¼Œå¥¹å†·å¾—é–‹å§‹ç™¼æŠ–ã€‚" },
            { word: "unlimited", pos: "(adj.)", meaning: "ç„¡é™çš„", enDef: "Without any limit or end.", sentence: "This phone plan offers unlimited data usage.", cnSentence: "é€™å€‹é›»è©±æ–¹æ¡ˆæä¾›ç„¡é™çš„æ•¸æ“šæµé‡ã€‚" },
            { word: "unusual", pos: "(adj.)", meaning: "ä¸å°‹å¸¸çš„", enDef: "Different from what is normal or expected.", sentence: "It is unusual for him to be late; he is usually on time.", cnSentence: "ä»–é²åˆ°å¾ˆä¸å°‹å¸¸ï¼›ä»–é€šå¸¸éƒ½å¾ˆæº–æ™‚ã€‚" },
            { word: "urchin", pos: "(n.)", meaning: "æµ·è†½ï¼›é ‘ç«¥", enDef: "A sea animal with spines; or a naughty child.", sentence: "Be careful not to step on a sea urchin when walking in the water.", cnSentence: "åœ¨æ°´ä¸­è¡Œèµ°æ™‚è¦å°å¿ƒä¸è¦è¸©åˆ°æµ·è†½ã€‚" },
            { word: "veil", pos: "(n.)", meaning: "é¢ç´—", enDef: "A thin piece of cloth used to cover the face.", sentence: "The bride lifted her veil to smile at the groom.", cnSentence: "æ–°å¨˜æ€èµ·é¢ç´—å°æ–°éƒå¾®ç¬‘ã€‚" },
            { word: "vulture", pos: "(n.)", meaning: "ç¦¿é·²", enDef: "A large bird that eats dead animals.", sentence: "Vultures circled in the sky, looking for food on the ground.", cnSentence: "ç¦¿é·²åœ¨ç©ºä¸­ç›¤æ—‹ï¼Œå°‹æ‰¾åœ°é¢ä¸Šçš„é£Ÿç‰©ã€‚" },
            { word: "weakness", pos: "(n.)", meaning: "ç¼ºé»ï¼›å¼±é»", enDef: "A fault or lack of strength.", sentence: "Superman's only weakness is Kryptonite.", cnSentence: "è¶…äººå”¯ä¸€çš„å¼±é»æ˜¯æ°ªæ˜ŸçŸ³ã€‚" },
            { word: "weasel", pos: "(n.)", meaning: "é¼¬é¼ ", enDef: "A small, thin mammal that eats small animals.", sentence: "A weasel is a small, quick animal with a long body.", cnSentence: "é¼¬é¼ æ˜¯ä¸€ç¨®èº«é«”é•·é•·ã€å‹•ä½œæ•æ·çš„å°å‹•ç‰©ã€‚" },
            { word: "witness", pos: "(n.)", meaning: "ç›®æ“Šè€…ï¼›(v.) ç›®æ“Š", enDef: "A person who sees an event happen.", sentence: "The police are looking for a witness to the car accident.", cnSentence: "è­¦æ–¹æ­£åœ¨å°‹æ‰¾é€™å ´è»Šç¦çš„ç›®æ“Šè€…ã€‚" },
            { word: "worthless", pos: "(adj.)", meaning: "æ²’åƒ¹å€¼çš„", enDef: "Having no value or use.", sentence: "Without the key, this old treasure chest is worthless.", cnSentence: "æ²’æœ‰é‘°åŒ™ï¼Œé€™å€‹èˆŠå¯¶ç®±å°±æ²’æœ‰åƒ¹å€¼äº†ã€‚" },
            { word: "wrinkle", pos: "(n.)", meaning: "çšºç´‹", enDef: "A small line on the skin caused by age.", sentence: "My grandmother has wrinkles around her eyes when she smiles.", cnSentence: "æˆ‘ç¥–æ¯ç¬‘çš„æ™‚å€™çœ¼ç›å‘¨åœæœƒæœ‰çšºç´‹ã€‚" }
        ]}
    };

    // --- 2. éŠæˆ²ç‹€æ…‹ ---
    let state = {
        tokens: 0,
        username: "å°å­¸å“¡",
        userId: null,
        unlockedItems: ['avatar_0', 'theme_default', 'sfx_default'],
        currentAvatar: 'ğŸ‘¦',
        currentTheme: 'theme_default',
        currentSfx: 'sfx_default',
        
        currentWords: [], currentIndex: 0, correctCount: 0, wrongCount: 0,
        startTime: null, timerInterval: null, wrongWords: [], combo: 0,
        userRecordings: {}, mediaRecorder: null, audioChunks: [], isRecording: false
    };

    // --- 3. åˆå§‹åŒ–èˆ‡é›²ç«¯åŒæ­¥ ---
    async function init() {
        renderCategories(); // Prepare UI
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„ä½¿ç”¨è€…
        const savedName = localStorage.getItem('spellingGameUserName');
        if (savedName) {
            await login(savedName, false); // è‡ªå‹•ç™»å…¥ï¼Œä¸é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        } else {
            document.getElementById('loginScreen').style.display = 'flex'; // é¡¯ç¤ºç™»å…¥ç•«é¢
            document.getElementById('loadingScreen').style.display = 'none'; // éš±è—å…¨åŸŸè¼‰å…¥
        }
    }

    // ç™»å…¥é‚è¼¯
    async function login(name, showLoading = true) {
        state.username = name;
        // ç”¢ç”Ÿå›ºå®šçš„ User ID
        state.userId = "USER_" + name.toUpperCase();
        localStorage.setItem('spellingGameUserName', name);
        
        document.getElementById('loginScreen').style.display = 'none';
        if(showLoading) document.getElementById('loadingScreen').style.display = 'flex';

        // è¼‰å…¥è³‡æ–™ (é›²ç«¯æˆ–æœ¬åœ°)
        if (GAS_URL) {
            try {
                const response = await fetch(`${GAS_URL}?action=get&userId=${state.userId}`);
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    const d = result.data;
                    state.tokens = d.tokens || 0;
                    state.unlockedItems = d.items || ['avatar_0', 'theme_default', 'sfx_default'];
                    state.currentAvatar = d.avatar || 'ğŸ‘¦';
                    state.currentTheme = d.theme || 'theme_default';
                    state.currentSfx = d.sfx || 'sfx_default';
                    updateSyncStatus('saved');
                } else {
                    console.log("New user or no remote data");
                    // å¦‚æœæ˜¯æ–°ç”¨æˆ¶ï¼Œå˜—è©¦è®€å–æœ¬åœ°èˆŠè³‡æ–™ (å¦‚æœæœ‰çš„è©±)ï¼Œå¦å‰‡é‡ç½®
                    loadLocalBackup();
                }
            } catch (e) {
                console.error("Sync error:", e);
                loadLocalBackup();
                updateSyncStatus('error');
            }
        } else {
            loadLocalBackup();
        }
        
        if(showLoading) document.getElementById('loadingScreen').style.display = 'none';
        
        applyTheme(state.currentTheme);
        updateUI();
        setupAudio();
    }

    // ç™»å‡ºæç¤º
    function showLogoutOption() {
        showConfirm(`ç›®å‰ç™»å…¥ï¼š${state.username}\nè¦ç™»å‡ºåˆ‡æ›ä½¿ç”¨è€…å—ï¼Ÿ`, () => {
            localStorage.removeItem('spellingGameUserName');
            location.reload();
        });
    }

    function loadLocalBackup() {
        // å˜—è©¦å¾æœ¬åœ°è®€å–è©²ä½¿ç”¨è€…çš„è³‡æ–™ (å¦‚æœæœ‰çš„è©±)
        // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨å¸¶æœ‰ userId çš„ key ä¾†å€åˆ†ä¸åŒä½¿ç”¨è€…çš„æœ¬åœ°è³‡æ–™
        const saved = localStorage.getItem('spellingGameData_' + state.userId);
        if (saved) {
            const parsed = JSON.parse(saved);
            state.tokens = parsed.tokens || 0;
            state.unlockedItems = parsed.unlockedItems || ['avatar_0', 'theme_default', 'sfx_default'];
            state.currentAvatar = parsed.currentAvatar || 'ğŸ‘¦';
            state.currentTheme = parsed.currentTheme || 'theme_default';
            state.currentSfx = parsed.currentSfx || 'sfx_default';
        } else {
            // å®Œå…¨æ–°ç”¨æˆ¶ï¼Œé‡ç½®ç‹€æ…‹
            state.tokens = 0;
            state.unlockedItems = ['avatar_0', 'theme_default', 'sfx_default'];
            state.currentAvatar = 'ğŸ‘¦';
            state.currentTheme = 'theme_default';
            state.currentSfx = 'sfx_default';
        }
    }

    function saveData() {
        // å„²å­˜åˆ°æœ¬åœ° (å¸¶æœ‰ UserID)
        localStorage.setItem('spellingGameData_' + state.userId, JSON.stringify({
            tokens: state.tokens,
            username: state.username,
            unlockedItems: state.unlockedItems,
            currentAvatar: state.currentAvatar,
            currentTheme: state.currentTheme,
            currentSfx: state.currentSfx
        }));
        
        updateUI();

        // å˜—è©¦åŒæ­¥åˆ°é›²ç«¯
        if (GAS_URL) {
            updateSyncStatus('saving');
            const payload = {
                userId: state.userId,
                action: 'save',
                tokens: state.tokens,
                username: state.username,
                items: state.unlockedItems,
                avatar: state.currentAvatar,
                theme: state.currentTheme,
                sfx: state.currentSfx
            };

            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                updateSyncStatus('saved');
            }).catch(e => {
                console.error("Save error:", e);
                updateSyncStatus('error');
            });
        }
    }

    // ç¨±è™Ÿé‚è¼¯
    function getTitle(level) {
        if (level >= 100) return "å‚³å¥‡ç‹è€…";
        if (level >= 80) return "è‹±èªåšå­¸å£«";
        if (level >= 60) return "å–®å­—é”äºº";
        if (level >= 40) return "æ‹¼å­—å¥½æ‰‹";
        if (level >= 20) return "æ½›åŠ›æ–°æ˜Ÿ";
        return "åˆå­¸æ–°æ‰‹";
    }

    function updateUI() {
        document.getElementById('tokens').innerText = state.tokens;
        document.getElementById('storeTokens').innerText = state.tokens;
        document.getElementById('currentAvatar').innerText = state.currentAvatar;
        
        // é¡¯ç¤ºä½¿ç”¨è€…åç¨±
        document.getElementById('usernameDisplay').innerText = state.username;

        // ä¿®æ”¹å‡ç´šå…¬å¼ï¼šæ¯300åˆ†å‡ä¸€ç´š
        const currentLevel = 1 + Math.floor(state.tokens / 300);
        const currentTitle = getTitle(currentLevel);
        
        document.getElementById('level').innerText = currentLevel;
        document.getElementById('userTitle').innerText = currentTitle;
    }

    function renderCategories() {
        const container = document.getElementById('categoryList');
        container.innerHTML = '';
        for (const [key, data] of Object.entries(wordBanks)) {
            const btn = document.createElement('button');
            btn.className = 'cat-btn';
            btn.innerHTML = `${data.title}<span>${data.desc}</span>`;
            btn.onclick = () => selectCategory(btn, key);
            container.appendChild(btn);
        }
    }

    let selectedCategory = null;
    function selectCategory(btn, key) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedCategory = key;
    }

    function startGame(isRetry = false) {
        if (!selectedCategory && !isRetry) {
            showAlert("è«‹å…ˆé¸æ“‡ä¸€å€‹å–®å…ƒ (Part 1 - Part 4)ï¼");
            return;
        }

        if (!isRetry) {
            let words = JSON.parse(JSON.stringify(wordBanks[selectedCategory].data));
            const isRandom = document.getElementById('randomMode').checked;
            if (isRandom) words.sort(() => Math.random() - 0.5);
            state.currentWords = words;
        } else {
            state.currentWords = [...state.wrongWords];
        }

        state.currentIndex = 0;
        state.correctCount = 0;
        state.wrongCount = 0;
        state.wrongWords = [];
        state.combo = 0;
        state.userRecordings = {};

        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('resultScreen').style.display = 'none';
        document.getElementById('gameArea').classList.add('active');
        
        state.startTime = Date.now();
        state.timerInterval = setInterval(updateTimer, 1000);

        loadWord();
    }
    
    function quitGame() {
        showConfirm("ç¢ºå®šè¦çµæŸç›®å‰çš„ç·´ç¿’ä¸¦è¿”å›åˆ—è¡¨å—ï¼Ÿ", () => {
            clearInterval(state.timerInterval);
            stopRecording(); 
            document.getElementById('gameArea').classList.remove('active');
            document.getElementById('setupScreen').style.display = 'flex'; 
        });
    }

    function updateTimer() {
        const diff = Math.floor((Date.now() - state.startTime) / 1000);
        const m = Math.floor(diff / 60).toString().padStart(2, '0');
        const s = (diff % 60).toString().padStart(2, '0');
        document.getElementById('timerDisplay').innerText = `${m}:${s}`;
    }

    function loadWord() {
        const currentObj = state.currentWords[state.currentIndex];
        
        document.getElementById('wordsLeft').innerText = state.currentWords.length - state.currentIndex;
        document.getElementById('displayPos').innerText = currentObj.pos;
        document.getElementById('displayMeaning').innerHTML = '<span style="color:#ccc; font-size:0.9em; font-style:italic;">(ä½œç­”å¾Œé¡¯ç¤ºä¸­æ–‡)</span>';
        document.getElementById('displayDef').innerText = currentObj.enDef;
        document.getElementById('displaySentence').innerHTML = '<span style="color:#ccc; font-size:0.9em; font-style:italic;">(ä½œç­”å¾Œé¡¯ç¤ºä¾‹å¥)</span>';

        const input = document.getElementById('answerInput');
        input.value = '';
        input.focus();
        input.className = 'input-box';
        document.getElementById('feedback').innerText = '';
        
        document.getElementById('recStatus').innerText = "éŒ„éŸ³ç·´ç¿’";
        document.getElementById('playRecordBtn').disabled = true;
        if (state.userRecordings[currentObj.word]) {
             document.getElementById('playRecordBtn').disabled = false;
             document.getElementById('recStatus').innerText = "å·²æœ‰éŒ„éŸ³";
        }

        document.getElementById('submitBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';

        playCurrentWord(0);
    }

    function revealInfo() {
        const currentObj = state.currentWords[state.currentIndex];
        document.getElementById('displayMeaning').innerText = currentObj.meaning;
        const regex = new RegExp(`(${currentObj.word})`, 'gi');
        const highlightedSentence = currentObj.sentence.replace(regex, '<em>$1</em>');
        document.getElementById('displaySentence').innerHTML = `${highlightedSentence}<br><small style="color:#888">${currentObj.cnSentence}</small>`;
    }

    function checkAnswer() {
        const input = document.getElementById('answerInput');
        const userAns = input.value.trim().toLowerCase();
        const currentObj = state.currentWords[state.currentIndex];
        const correctAns = currentObj.word.toLowerCase();
        const feedback = document.getElementById('feedback');

        revealInfo();

        if (userAns === correctAns) {
            playSound('correct');
            input.classList.add('correct');
            state.correctCount++;
            document.getElementById('scoreCorrect').innerText = state.correctCount;
            
            state.combo++;
            let earned = 10 + (state.combo * 1);
            
            const oldLevel = 1 + Math.floor(state.tokens / 300);
            const oldTitle = getTitle(oldLevel);
            
            state.tokens += earned; 
            
            const newLevel = 1 + Math.floor(state.tokens / 300);
            const newTitle = getTitle(newLevel);
            
            if (newLevel > oldLevel) {
                setTimeout(() => {
                    if (newTitle !== oldTitle) {
                        showAlert(`ğŸ‰ æ­å–œæ™‰å‡ï¼\nä½ ç¾åœ¨æ˜¯ Lv.${newLevel} ã€Œ${newTitle}ã€äº†ï¼`);
                        playSound('correct'); 
                    } else {
                        showAlert(`ğŸ†™ æ­å–œå‡ç´šï¼\nç›®å‰ç­‰ç´šï¼šLv.${newLevel}`);
                    }
                }, 500);
            }

            saveData();
            
            feedback.innerText = "Correct! +" + earned;
            feedback.style.color = "green";

            if (state.combo > 1) {
                const comboEl = document.getElementById('comboDisplay');
                comboEl.innerText = `COMBO x${state.combo}!`;
                comboEl.classList.add('show');
                setTimeout(() => comboEl.classList.remove('show'), 1000);
            }
        } else {
            playSound('wrong');
            input.classList.add('wrong');
            state.wrongCount++;
            state.combo = 0;
            document.getElementById('scoreWrong').innerText = state.wrongCount;
            
            feedback.innerText = `Answer: ${correctAns}`;
            feedback.style.color = "red";
            
            if (!state.wrongWords.some(w => w.word === currentObj.word)) {
                state.wrongWords.push(currentObj);
            }

            setTimeout(() => input.classList.remove('wrong'), 500);
        }

        document.getElementById('submitBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').focus();
    }

    function nextWord() {
        state.currentIndex++;
        if (state.currentIndex < state.currentWords.length) {
            loadWord();
        } else {
            endGame();
        }
    }

    function endGame() {
        clearInterval(state.timerInterval);
        document.getElementById('gameArea').classList.remove('active');
        document.getElementById('resultScreen').style.display = 'flex'; 
        
        const diff = Math.floor((Date.now() - state.startTime) / 1000);
        const m = Math.floor(diff / 60).toString().padStart(2, '0');
        const s = (diff % 60).toString().padStart(2, '0');
        
        document.getElementById('finalTime').innerText = `${m}:${s}`;
        document.getElementById('finalScore').innerText = Math.round((state.correctCount / state.currentWords.length) * 100);
        document.getElementById('earnedTokens').innerText = "å·²å­˜å…¥";

        const wrongList = document.getElementById('wrongWordsList');
        const wrongArea = document.getElementById('wrongWordsArea');
        wrongList.innerHTML = '';
        if (state.wrongWords.length > 0) {
            wrongArea.style.display = 'block';
            state.wrongWords.forEach(obj => {
                let li = document.createElement('li');
                li.innerText = `${obj.word} (${obj.meaning})`;
                wrongList.appendChild(li);
            });
        } else {
            wrongArea.style.display = 'none';
        }
    }

    function retryWrong() {
        startGame(true);
    }

    document.getElementById('answerInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            checkAnswer();
        }
    });

    function playCurrentWord(type) {
        const text = state.currentWords[state.currentIndex].word;
        speakText(text, type);
        document.getElementById('answerInput').focus();
    }

    function playSentence() {
        const sentence = state.currentWords[state.currentIndex].sentence;
        speakText(sentence, 0); 
    }

    function speakText(text, type) {
        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';

        switch(type) {
            case 0: 
                utterance.rate = 1; utterance.pitch = 1;
                break;
            case 1: 
                utterance.rate = 0.7; utterance.pitch = 0.5;
                break;
            case 2: 
                utterance.rate = 1.3; utterance.pitch = 1.5;
                break;
            case 3: 
                utterance.rate = 0.8; utterance.pitch = 0.2;
                break;
        }

        synth.cancel();
        synth.speak(utterance);
    }

    function toggleRecording() {
        if (state.isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    }

    async function startRecording() {
        if (!navigator.mediaDevices) {
            showAlert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³ï¼Œè«‹ä½¿ç”¨ Chrome ä¸¦å…è¨±éº¥å…‹é¢¨æ¬Šé™ã€‚");
            return;
        }
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            let options = { mimeType: 'audio/webm' };
            if (MediaRecorder.isTypeSupported('audio/webm')) {
                options.mimeType = 'audio/webm';
            } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                options.mimeType = 'audio/mp4';
            } else {
                options = undefined;
            }

            state.mediaRecorder = new MediaRecorder(stream, options);
            state.audioChunks = [];

            state.mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    state.audioChunks.push(event.data);
                }
            };

            state.mediaRecorder.onstop = () => {
                const mimeType = state.mediaRecorder.mimeType || 'audio/webm';
                const audioBlob = new Blob(state.audioChunks, { type: mimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                const currentWord = state.currentWords[state.currentIndex].word;
                
                state.userRecordings[currentWord] = audioUrl;
                document.getElementById('playRecordBtn').disabled = false; 
            };

            state.mediaRecorder.start();
            state.isRecording = true;
            document.getElementById('recordBtn').classList.add('recording');
            document.getElementById('recStatus').innerText = "éŒ„éŸ³ä¸­...";
        } catch (err) {
            console.error("éŒ„éŸ³éŒ¯èª¤:", err);
            showAlert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨");
        }
    }

    function stopRecording() {
        if (state.mediaRecorder && state.isRecording) {
            state.mediaRecorder.stop();
            state.isRecording = false;
            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('recStatus').innerText = "éŒ„éŸ³å®Œæˆ";
        }
    }

    function playUserRecording() {
        const currentWord = state.currentWords[state.currentIndex].word;
        const audioUrl = state.userRecordings[currentWord];
        if (audioUrl) {
            const audio = new Audio(audioUrl);
            audio.play().catch(e => console.error("æ’­æ”¾å¤±æ•—:", e));
        }
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        let freq = type === 'correct' ? 600 : 150;
        let typeWave = type === 'correct' ? 'sine' : 'sawtooth';
        
        if (state.currentSfx === 'sfx_8bit') {
             typeWave = 'square';
        }

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = typeWave;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        
        if (type === 'correct') {
            osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
        } else {
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
        }

        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
    }

    // --- å•†åŸé‚è¼¯ ---
    const storeItems = {
        avatars: [
            { id: 'avatar_0', icon: 'ğŸ‘¦', price: 0 },
            { id: 'avatar_1', icon: 'ğŸ‘§', price: 50 },
            { id: 'avatar_2', icon: 'ğŸ¶', price: 100 },
            { id: 'avatar_3', icon: 'ğŸ±', price: 100 },
            { id: 'avatar_4', icon: 'ğŸ¤–', price: 200 },
            { id: 'avatar_5', icon: 'ğŸ‘½', price: 500 }
        ],
        themes: [
            { id: 'theme_default', name: 'è—å¤©ç™½é›²', class: '', price: 0 },
            { id: 'theme_forest', name: 'æ£®æ—ç³»', class: 'theme-forest', price: 150 },
            { id: 'theme_candy', name: 'ç²‰ç´…ç³–æœ', class: 'theme-candy', price: 150 },
            { id: 'theme_dark', name: 'æ·±è‰²è­·çœ¼', class: 'theme-dark', price: 300 }
        ],
        sfx: [
            { id: 'sfx_default', name: 'æ¨™æº–éŸ³æ•ˆ', price: 0 },
            { id: 'sfx_8bit', name: '8-bit é›»ç©éŸ³', price: 200 }
        ]
    };

    function openStore() {
        document.getElementById('storeModal').classList.add('active');
        renderStore();
    }

    function renderStore() {
        const renderSection = (items, containerId, type) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                const isOwned = state.unlockedItems.includes(item.id);
                const isEquipped = (state.currentAvatar === item.icon) || (state.currentTheme === item.id) || (state.currentSfx === item.id);
                
                div.className = `store-item ${isOwned ? 'owned' : ''}`;
                if (!isOwned && state.tokens < item.price) div.classList.add('locked');
                
                let content = type === 'avatar' ? `<div style="font-size:30px">${item.icon}</div>` : `<div>${item.name}</div>`;
                content += `<span class="price-tag">${isOwned ? (isEquipped ? 'ä½¿ç”¨ä¸­' : 'å·²æ“æœ‰') : item.price + 'ğŸ’°'}</span>`;
                
                div.innerHTML = content;
                div.onclick = () => buyOrEquip(item, type);
                container.appendChild(div);
            });
        };

        renderSection(storeItems.avatars, 'avatarStore', 'avatar');
        renderSection(storeItems.themes, 'themeStore', 'theme');
        renderSection(storeItems.sfx, 'sfxStore', 'sfx');
    }

    function buyOrEquip(item, type) {
        if (state.unlockedItems.includes(item.id)) {
            if (type === 'avatar') state.currentAvatar = item.icon;
            if (type === 'theme') { state.currentTheme = item.id; applyTheme(item.id); }
            if (type === 'sfx') state.currentSfx = item.id;
        } else {
            if (state.tokens >= item.price) {
                showConfirm(`ç¢ºå®šèŠ±è²» ${item.price} è³¼è²·å—ï¼Ÿ`, () => {
                    state.tokens -= item.price;
                    state.unlockedItems.push(item.id);
                    playSound('correct'); 
                    saveData(); 
                    renderStore(); 
                });
            } else {
                showAlert("ä»£å¹£ä¸è¶³ï¼");
                return;
            }
        }
        saveData();
        renderStore();
    }

    function applyTheme(themeId) {
        document.body.className = '';
        const theme = storeItems.themes.find(t => t.id === themeId);
        if (theme && theme.class) {
            document.body.classList.add(theme.class);
        }
    }

    function setupAudio() {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
        }
    }

    init();

</script>
</body>
</html>
